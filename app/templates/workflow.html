{% extends "base.html" %}

{% block title %}Policy Compliance Checker{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-5 mb-3">
                <i class="fas fa-shield-check me-3 text-primary"></i>
                Policy Compliance Checker
            </h1>
            <p class="lead text-muted">
                Upload a policy document to create AI agents, then check any document for compliance
            </p>
        </div>
    </div>

    <!-- Workflow Steps -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-center">
                <div class="workflow-steps d-flex align-items-center">
                    <div class="step" id="step-1">
                        <div class="step-circle active">1</div>
                        <div class="step-label">Upload Policy</div>
                    </div>
                    <div class="step-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    <div class="step" id="step-2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Upload Document</div>
                    </div>
                    <div class="step-arrow">
                        <i class="fas fa-arrow-right"></i>
                    </div>
                    <div class="step" id="step-3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Compliance Report</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 1: Policy Upload -->
    <div class="row" id="policy-section">
        <div class="col-md-8 mx-auto">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-contract me-2"></i>
                        Step 1: Upload Policy Document
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Upload your policy document (PDF, Word, Excel, etc.). AI will analyze it and create specialized compliance agents.
                    </p>
                    
                    <form id="policy-form" enctype="multipart/form-data">
                        <div class="file-upload-area mb-3" id="policy-upload-area">
                            <input type="file" class="form-control" id="policy-file" name="file" 
                                   accept=".pdf,.docx,.doc,.xlsx,.xls,.csv,.png,.jpg,.jpeg,.tiff,.bmp" required>
                            <div class="upload-placeholder text-center p-4">
                                <i class="fas fa-file-upload fa-3x text-primary mb-3"></i>
                                <h6>Drop your policy document here or click to browse</h6>
                                <p class="text-muted mb-0">Supports: PDF, Word, Excel, Images</p>
                            </div>
                        </div>
                        
                        <div class="policy-file-info" id="policy-file-info" style="display: none;"></div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Domain (Optional)</label>
                                <select class="form-select" name="domain_hint">
                                    <option value="">Auto-detect</option>
                                    <option value="financial">Financial</option>
                                    <option value="esg">ESG</option>
                                    <option value="regulatory">Regulatory</option>
                                    <option value="operational">Operational</option>
                                    <option value="hr">HR</option>
                                    <option value="technology">Technology</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">&nbsp;</label>
                                <button type="submit" class="btn btn-primary w-100" id="analyze-policy-btn" disabled>
                                    <i class="fas fa-robot me-2"></i>Create AI Agents
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Agents Created -->
    <div class="row mt-4" id="agents-section" style="display: none;">
        <div class="col-md-10 mx-auto">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        AI Agents Created Successfully
                    </h6>
                </div>
                <div class="card-body">
                    <div id="agents-summary">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: Document Upload -->
    <div class="row mt-4" id="document-section" style="display: none;">
        <div class="col-md-10 mx-auto">
            <div class="card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        Step 2: Upload Document to Check
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-4">
                        Upload the document you want to check for compliance against the policy.
                    </p>
                    
                    <form id="document-form" enctype="multipart/form-data">
                        <div class="file-upload-area mb-3" id="document-upload-area">
                            <input type="file" class="form-control" id="document-file" name="file" 
                                   accept=".pdf,.docx,.doc,.xlsx,.xls,.csv,.png,.jpg,.jpeg,.tiff,.bmp" required>
                            <div class="upload-placeholder text-center p-4">
                                <i class="fas fa-file-check fa-3x text-warning mb-3"></i>
                                <h6>Drop document to check here or click to browse</h6>
                                <p class="text-muted mb-0">Any document format supported</p>
                            </div>
                        </div>
                        
                        <div class="document-file-info" id="document-file-info" style="display: none;"></div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-warning btn-lg" id="check-compliance-btn" disabled>
                                <i class="fas fa-search me-2"></i>Check Compliance
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: Compliance Report -->
    <div class="row mt-4" id="report-section" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header" id="report-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Step 3: Compliance Report
                    </h5>
                </div>
                <div class="card-body">
                    <div id="compliance-report">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Processing Modal -->
    <div class="modal fade" id="processing-modal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 id="processing-title">Processing...</h5>
                    <p class="text-muted mb-0" id="processing-text">Please wait...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.workflow-steps {
    gap: 2rem;
}

.step {
    text-align: center;
}

.step-circle {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background-color: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 1.2rem;
    margin: 0 auto 0.5rem;
    transition: all 0.3s ease;
}

.step-circle.active {
    background-color: #0d6efd;
    color: white;
}

.step-circle.completed {
    background-color: #198754;
    color: white;
}

.step-label {
    font-size: 0.9rem;
    font-weight: 500;
    color: #6c757d;
}

.step.active .step-label {
    color: #0d6efd;
    font-weight: 600;
}

.step.completed .step-label {
    color: #198754;
    font-weight: 600;
}

.step-arrow {
    color: #dee2e6;
    font-size: 1.5rem;
}

.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    position: relative;
    transition: all 0.3s ease;
    cursor: pointer;
}

.file-upload-area:hover,
.file-upload-area.drag-over {
    border-color: #0d6efd;
    background-color: rgba(13, 110, 253, 0.05);
}

.file-upload-area input[type="file"] {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
    z-index: 2;
}

.upload-placeholder {
    pointer-events: none;
}

.compliance-metric {
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
}

.compliance-metric h3 {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.compliance-metric.success {
    background-color: rgba(25, 135, 84, 0.1);
    border: 2px solid #198754;
}

.compliance-metric.warning {
    background-color: rgba(255, 193, 7, 0.1);
    border: 2px solid #ffc107;
}

.compliance-metric.danger {
    background-color: rgba(220, 53, 69, 0.1);
    border: 2px solid #dc3545;
}

.compliance-metric.info {
    background-color: rgba(13, 202, 240, 0.1);
    border: 2px solid #0dcaf0;
}

/* Agent Cards Styling */
.agent-cards {
    margin: 0 -0.5rem;
}

.agent-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.3s ease;
    margin: 0 0.5rem;
    overflow: hidden;
}

.agent-card:hover {
    background: #ffffff;
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
    transform: translateY(-2px);
}

.agent-icon {
    flex-shrink: 0;
}

.agent-icon i {
    font-size: 1.2rem;
}

.agent-content {
    min-width: 0; /* Allow text to wrap */
    overflow: hidden;
}

.agent-content .badge {
    white-space: normal;
    word-break: break-word;
}

.agent-content small {
    display: block;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
    max-width: 100%;
}

.agent-description {
    font-size: 0.9rem;
    line-height: 1.4;
    color: #495057;
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
    hyphens: auto;
    max-height: 120px;
    overflow-y: auto;
    margin-bottom: 0.5rem;
}

/* Custom scrollbar for agent descriptions */
.agent-description::-webkit-scrollbar {
    width: 4px;
}

.agent-description::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 2px;
}

.agent-description::-webkit-scrollbar-thumb {
    background: #888;
    border-radius: 2px;
}

.agent-description::-webkit-scrollbar-thumb:hover {
    background: #555;
}

.agent-meta {
    border-top: 1px solid #e9ecef;
    padding-top: 0.5rem;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .agent-cards .col-md-6 {
        flex: 0 0 100%;
        max-width: 100%;
    }
    
    .agent-card {
        margin: 0 0 1rem 0;
    }
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let policyAgents = null;
    let complianceResults = null;
    
    const processingModal = new bootstrap.Modal(document.getElementById('processing-modal'));
    
    // File upload handlers
    setupFileUpload('policy-file', 'policy-upload-area', 'policy-file-info', 'analyze-policy-btn');
    setupFileUpload('document-file', 'document-upload-area', 'document-file-info', 'check-compliance-btn');
    
    // Form submissions
    document.getElementById('policy-form').addEventListener('submit', handlePolicyUpload);
    document.getElementById('document-form').addEventListener('submit', handleDocumentCheck);
    
    function setupFileUpload(inputId, areaId, infoId, buttonId) {
        const fileInput = document.getElementById(inputId);
        const uploadArea = document.getElementById(areaId);
        const fileInfo = document.getElementById(infoId);
        const submitBtn = document.getElementById(buttonId);
        
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                showFileInfo(file, fileInfo);
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        });
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                fileInput.files = files;
                showFileInfo(files[0], fileInfo);
                submitBtn.disabled = false;
            }
        });
    }
    
    function showFileInfo(file, container) {
        const fileSize = (file.size / 1024 / 1024).toFixed(2);
        container.innerHTML = `
            <div class="alert alert-info d-flex align-items-center">
                <i class="fas fa-file text-primary me-3"></i>
                <div>
                    <strong>${file.name}</strong>
                    <small class="d-block text-muted">${fileSize} MB • ${file.type || 'Unknown type'}</small>
                </div>
            </div>
        `;
        container.style.display = 'block';
    }
    
    function handlePolicyUpload(e) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        
        showProcessing('Creating AI Agents', 'Analyzing policy document and creating specialized compliance agents...');
        
        fetch('/analyze-document-policy', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            hideProcessing();
            
            if (data.error) {
                showAlert(data.error, 'danger');
                return;
            }
            
            policyAgents = data.extracted_policies || [];
            showAgentsCreated(data);
            activateStep(2);
        })
        .catch(error => {
            hideProcessing();
            showAlert('Error processing policy: ' + error.message, 'danger');
        });
    }
    
    function handleDocumentCheck(e) {
        e.preventDefault();
        
        if (!policyAgents || policyAgents.length === 0) {
            showAlert('No policy agents available. Please upload a policy first.', 'warning');
            return;
        }
        
        const formData = new FormData(e.target);
        
        showProcessing('Checking Compliance', 'Extracting document content and running compliance checks...');
        
        // First extract content from the document
        fetch('/upload-document', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(documentData => {
            if (documentData.error) {
                throw new Error(documentData.error);
            }
            
            // Now run compliance check
            return fetch('/check-compliance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    policy_checks: policyAgents,
                    data: extractDataFromDocument(documentData)
                })
            });
        })
        .then(response => response.json())
        .then(complianceData => {
            hideProcessing();
            
            if (complianceData.error) {
                showAlert(complianceData.error, 'danger');
                return;
            }
            
            complianceResults = complianceData;
            showComplianceReport(complianceData);
            activateStep(3);
        })
        .catch(error => {
            hideProcessing();
            showAlert('Error checking compliance: ' + error.message, 'danger');
        });
    }
    
    function extractDataFromDocument(documentData) {
        // Extract relevant data from the document for compliance checking
        const data = {};
        
        // Add document metadata
        if (documentData.document_analysis) {
            data.document_length = documentData.document_analysis.text_length || 0;
            data.tables_count = documentData.document_analysis.tables_count || 0;
            data.images_count = documentData.document_analysis.images_count || 0;
            data.charts_count = documentData.document_analysis.charts_count || 0;
        }
        
        // Extract text content
        if (documentData.parsed_content && documentData.parsed_content.text_content) {
            data.document_text = documentData.parsed_content.text_content;
        }
        
        // Extract table data
        if (documentData.parsed_content && documentData.parsed_content.tables) {
            documentData.parsed_content.tables.forEach((table, index) => {
                if (table.analysis && table.analysis.potential_metrics) {
                    table.analysis.potential_metrics.forEach(metric => {
                        if (metric.sample_values && metric.sample_values.length > 0) {
                            data[`table_${index}_${metric.column}`] = metric.sample_values[0];
                        }
                    });
                }
            });
        }
        
        // Extract visual metrics
        if (documentData.visual_metrics) {
            documentData.visual_metrics.forEach((metric, index) => {
                if (metric.data_points && metric.data_points.length > 0) {
                    data[`visual_metric_${index}`] = metric.data_points[0];
                }
            });
        }
        
        return data;
    }
    
    function showAgentsCreated(data) {
        const container = document.getElementById('agents-summary');
        const agentCount = policyAgents.length;
        
        let html = `
            <div class="row mb-3">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h3 text-success">${agentCount}</div>
                        <small class="text-muted">AI Agents Created</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h3 text-info">${data.document_analysis?.content_types?.length || 0}</div>
                        <small class="text-muted">Content Types</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="h3 text-primary">${data.agents_preview?.by_domain ? Object.keys(data.agents_preview.by_domain).length : 0}</div>
                        <small class="text-muted">Domains</small>
                    </div>
                </div>
            </div>
        `;
        
        if (policyAgents.length > 0) {
            html += `
                <div class="mb-3">
                    <h6>Created Agents:</h6>
                    <div class="agent-cards row">
            `;
            
            policyAgents.forEach((agent, index) => {
                const priorityClass = {
                    'critical': 'danger',
                    'high': 'warning',
                    'medium': 'info',
                    'low': 'secondary'
                }[agent.priority] || 'secondary';
                
                // No truncation - let CSS handle text wrapping
                const fullDescription = agent.description;
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="agent-card h-100">
                            <div class="d-flex align-items-start">
                                <div class="agent-icon me-3">
                                    <i class="fas fa-robot text-primary"></i>
                                </div>
                                <div class="agent-content flex-grow-1">
                                    <div class="mb-2">
                                        <span class="badge bg-${priorityClass} me-2">${agent.priority}</span>
                                        <small class="text-muted text-break">${agent.check_type || 'Policy Check'}</small>
                                    </div>
                                    <div class="agent-description">
                                        ${fullDescription}
                                    </div>
                                    <div class="agent-meta mt-2">
                                        <small class="text-muted">Agent #${index + 1}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div class="text-center mt-3">
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            ${policyAgents.length} AI agents created and ready for compliance checking
                        </small>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
        document.getElementById('agents-section').style.display = 'block';
        document.getElementById('document-section').style.display = 'block';
    }
    
    function showComplianceReport(data) {
        const container = document.getElementById('compliance-report');
        const analysis = data.analysis;
        const results = data.compliance_results;
        
        // Update header based on overall status
        const header = document.getElementById('report-header');
        const statusConfig = {
            'fully_compliant': { class: 'bg-success text-white', icon: 'check-circle', text: 'Fully Compliant' },
            'partially_compliant': { class: 'bg-warning text-white', icon: 'exclamation-triangle', text: 'Partially Compliant' },
            'non_compliant': { class: 'bg-danger text-white', icon: 'times-circle', text: 'Non-Compliant' },
            'critical_failure': { class: 'bg-danger text-white', icon: 'ban', text: 'Critical Failure' },
            'high_risk': { class: 'bg-warning text-white', icon: 'exclamation-triangle', text: 'High Risk' }
        };
        
        const status = statusConfig[analysis.overall_status] || statusConfig['non_compliant'];
        header.className = `card-header ${status.class}`;
        header.innerHTML = `
            <h5 class="mb-0">
                <i class="fas fa-${status.icon} me-2"></i>
                Compliance Report - ${status.text}
            </h5>
        `;
        
        // Document classification info
        let html = '';
        if (analysis.document_classification && analysis.document_classification.document_type) {
            const docType = analysis.document_classification.document_type;
            const confidence = Math.round(analysis.document_classification.classification_confidence * 100);
            html += `
                <div class="alert alert-info mb-4">
                    <i class="fas fa-file-alt me-2"></i>
                    <strong>Document Type Detected:</strong> ${docType.replace('_', ' ').toUpperCase()}
                    <span class="badge bg-secondary ms-2">Confidence: ${confidence}%</span>
                    <br>
                    <small class="text-muted">
                        Applied ${analysis.summary.executed_checks} relevant checks out of ${analysis.summary.total_checks} total
                        (${analysis.summary.skipped_checks} checks skipped as not applicable)
                    </small>
                </div>
            `;
        }
        
        // Summary metrics
        const passRate = Math.round(analysis.summary.pass_rate * 100);
        html += `
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="compliance-metric ${passRate >= 80 ? 'success' : passRate >= 60 ? 'warning' : 'danger'}">
                        <h3>${passRate}%</h3>
                        <div>Overall Compliance</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="compliance-metric success">
                        <h3>${analysis.summary.passed}</h3>
                        <div>Passed Checks</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="compliance-metric danger">
                        <h3>${analysis.summary.failed}</h3>
                        <div>Failed Checks</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="compliance-metric info">
                        <h3>${analysis.summary.skipped_checks || 0}</h3>
                        <div>Skipped Checks</div>
                    </div>
                </div>
            </div>
        `;
        
        // Detailed results
        html += `
            <div class="mb-4">
                <h6>Detailed Results</h6>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="50">Status</th>
                                <th>Check</th>
                                <th>Result</th>
                                <th width="100">Priority</th>
                            </tr>
                        </thead>
                        <tbody>
        `;
        
        // Separate executed and skipped results
        const executedResults = results.filter(r => r.status !== 'skipped');
        const skippedResults = results.filter(r => r.status === 'skipped');
        
        // Show executed results first
        executedResults.forEach(result => {
            const statusIcon = result.passed ? 
                '<i class="fas fa-check-circle text-success"></i>' : 
                '<i class="fas fa-times-circle text-danger"></i>';
            
            const priorityClass = {
                'critical': 'danger',
                'high': 'warning',
                'medium': 'info',
                'low': 'secondary'
            }[result.priority] || 'secondary';
            
            html += `
                <tr>
                    <td class="text-center">${statusIcon}</td>
                    <td>
                        <strong>${result.description}</strong>
                        <br><small class="text-muted">${result.check_type}</small>
                    </td>
                    <td>
                        ${result.reason || 'No details available'}
                        ${result.actual_value !== undefined ? `<br><small><strong>Value:</strong> ${result.actual_value}</small>` : ''}
                    </td>
                    <td>
                        <span class="badge bg-${priorityClass}">${result.priority}</span>
                    </td>
                </tr>
            `;
        });
        
        // Show skipped results if any
        if (skippedResults.length > 0) {
            html += `
                <tr class="table-secondary">
                    <td colspan="4" class="text-center"><strong>Skipped Checks (Not Applicable)</strong></td>
                </tr>
            `;
            
            skippedResults.forEach(result => {
                html += `
                    <tr class="text-muted">
                        <td class="text-center"><i class="fas fa-minus-circle text-secondary"></i></td>
                        <td>
                            <strong>${result.description}</strong>
                            <br><small class="text-muted">${result.check_type}</small>
                        </td>
                        <td>
                            <em>${result.skip_reason || 'Not applicable to document type'}</em>
                            ${result.relevance_score !== undefined ? `<br><small>Relevance: ${Math.round(result.relevance_score * 100)}%</small>` : ''}
                        </td>
                        <td>
                            <span class="badge bg-secondary">${result.priority}</span>
                        </td>
                    </tr>
                `;
            });
        }
        
        html += `
                        </tbody>
                    </table>
                </div>
            </div>
        `;
        
        // Recommendations
        if (analysis.recommendations && analysis.recommendations.length > 0) {
            html += `
                <div class="mb-4">
                    <h6>Recommendations</h6>
                    <ul class="list-group">
            `;
            
            analysis.recommendations.forEach(rec => {
                html += `<li class="list-group-item">${rec}</li>`;
            });
            
            html += `
                    </ul>
                </div>
            `;
        }
        
        // Action buttons
        html += `
            <div class="text-center">
                <button class="btn btn-primary me-2" onclick="downloadReport()">
                    <i class="fas fa-download me-2"></i>Download Report
                </button>
                <button class="btn btn-outline-secondary me-2" onclick="startOver()">
                    <i class="fas fa-redo me-2"></i>Start Over
                </button>
                <button class="btn btn-outline-info" onclick="shareReport()">
                    <i class="fas fa-share me-2"></i>Share Report
                </button>
            </div>
        `;
        
        container.innerHTML = html;
        document.getElementById('report-section').style.display = 'block';
        
        // Scroll to report
        document.getElementById('report-section').scrollIntoView({ behavior: 'smooth' });
    }
    
    function activateStep(stepNumber) {
        // Update step indicators
        for (let i = 1; i <= 3; i++) {
            const step = document.getElementById(`step-${i}`);
            const circle = step.querySelector('.step-circle');
            
            if (i < stepNumber) {
                circle.classList.remove('active');
                circle.classList.add('completed');
                step.classList.remove('active');
                step.classList.add('completed');
            } else if (i === stepNumber) {
                circle.classList.remove('completed');
                circle.classList.add('active');
                step.classList.remove('completed');
                step.classList.add('active');
            } else {
                circle.classList.remove('active', 'completed');
                step.classList.remove('active', 'completed');
            }
        }
    }
    
    function showProcessing(title, text) {
        document.getElementById('processing-title').textContent = title;
        document.getElementById('processing-text').textContent = text;
        processingModal.show();
    }
    
    function hideProcessing() {
        processingModal.hide();
    }
    
    function showAlert(message, type) {
        // Use the global alert function from main.js
        if (window.showAlert) {
            window.showAlert(message, type);
        } else {
            alert(message);
        }
    }
    
    // Global functions for buttons
    window.downloadReport = function() {
        if (complianceResults) {
            const reportData = {
                timestamp: new Date().toISOString(),
                compliance_results: complianceResults,
                summary: complianceResults.analysis.summary
            };
            
            if (window.downloadJSON) {
                window.downloadJSON(reportData, 'compliance-report.json');
            } else {
                showAlert('Download feature not available', 'warning');
            }
        }
    };
    
    window.startOver = function() {
        if (confirm('Are you sure you want to start over? This will reset all progress.')) {
            location.reload();
        }
    };
    
    window.shareReport = function() {
        if (navigator.share && complianceResults) {
            navigator.share({
                title: 'Policy Compliance Report',
                text: `Compliance Score: ${Math.round(complianceResults.analysis.summary.pass_rate * 100)}%`,
                url: window.location.href
            });
        } else {
            showAlert('Share feature not available on this device', 'info');
        }
    };
});
</script>
{% endblock %}